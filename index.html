<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>10 Code Store — Sahibul Musa Sium</title>
  <style>
    body { font-family: system-ui, Arial; margin:0; padding:20px; background:#f5f7fb; color:#111; }
    h1 { font-size:22px; margin-bottom:20px; text-align:center; }
    section.snippet { margin-bottom:30px; background:white; padding:15px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    h2 { margin-top:0; font-size:16px; color:#2563eb; }
    .subtitle { font-size:13px; color:#555; margin-top:-5px; margin-bottom:10px; font-style:italic; }
    textarea { width:100%; height:220px; box-sizing:border-box; font-family:"Courier New", monospace; font-size:13px;
      padding:10px; border-radius:8px; border:1px solid #d7e0ef; background:#fdfdfd; white-space:pre; overflow:auto; resize:vertical; }
    .controls { margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; }
    button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; cursor:pointer; }
    button:hover { background:#f0f0f0; }
    .btn-blue { background:#2563eb; color:white; border-color:#1e4ed8; }
    .btn-green { background:#0d9488; color:white; border-color:#0b806f; }
  </style>
</head>
<body>
  <h1>10 Code Store — Sahibul Musa Sium</h1>

  <!-- Code 1 -->
  <section class="snippet">
    <h2>Code 1</h2>
    <div class="subtitle">Update apscript Code</div>
    <textarea id="code1" spellcheck="false" wrap="off">/************************************
 * Dakhil-26 (BOM) – Web App API
 * Works with your HTML site's normalizeRow()
 * Author: Sahibul Musa Sium (with ❤️)
 ************************************/

// ====== CONFIG ======
const SPREADSHEET_ID = '1GuSncL5wpCvsrnf0KHfUUOImDdT2GkTPRmaguRSapCU';
const SHEET_NAME = 'Form Responses 1';

// ====== UTIL ======
function respondJson(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj, null, 2))
    .setMimeType(ContentService.MimeType.JSON);
}

function isEmpty(v) { 
  return v === null || v === undefined || String(v).trim() === ''; 
}

function getHeaderIndices(headers) {
  console.log('All headers in sheet:', headers);
  
  const indices = {};
  
  // আপনার সঠিক হেডার নাম অনুযায়ী ম্যাচ করি
  for (let i = 0; i < headers.length; i++) {
    const header = String(headers[i] || '').trim();
    
    if (header === 'Timestamp') indices.timestamp = i;
    if (header === 'Subject Name:') indices.subject = i;
    if (header === 'Link:') indices.link = i;
    if (header === 'Title:') indices.title = i;
    if (header === 'File') indices.file = i; // নতুন হেডার যুক্ত
  }
  
  console.log('Found header indices:', indices);
  return indices;
}

function toIsoStringFromCell(cellValue) {
  try {
    if (cellValue instanceof Date) {
      return Utilities.formatDate(cellValue, Session.getScriptTimeZone(), "yyyy-MM-dd'T'HH:mm:ssXXX");
    }
    
    if (typeof cellValue === 'string' && cellValue.trim() !== '') {
      const parsed = new Date(cellValue);
      if (!isNaN(parsed.getTime())) {
        return Utilities.formatDate(parsed, Session.getScriptTimeZone(), "yyyy-MM-dd'T'HH:mm:ssXXX");
      }
      return cellValue; // Return original if can't parse
    }
  } catch (e) {
    console.error('Date parsing error:', e);
  }
  
  return String(cellValue || '');
}

// ====== CORE ======
function fetchRows(ssId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(ssId);
    const sh = ss.getSheetByName(sheetName);
    if (!sh) throw new Error(`Sheet "${sheetName}" not found`);
    
    const dataRange = sh.getDataRange();
    const values = dataRange.getValues();
    
    console.log('Total rows found:', values.length);
    if (values.length < 2) return [];

    const headers = values[0];
    const idx = getHeaderIndices(headers);

    // Check if we found the essential headers
    if (Object.keys(idx).length === 0) {
      throw new Error('No matching headers found. Available headers: ' + headers.join(', '));
    }

    const out = [];
    for (let r = 1; r < values.length; r++) {
      const row = values[r];
      
      // Skip empty rows
      if (row.every(cell => isEmpty(cell))) continue;

      const timestamp = idx.timestamp !== undefined ? row[idx.timestamp] : '';
      const subject = idx.subject !== undefined ? row[idx.subject] : '';
      const link = idx.link !== undefined ? row[idx.link] : '';
      const title = idx.title !== undefined ? row[idx.title] : '';
      const file = idx.file !== undefined ? row[idx.file] : ''; // নতুন ফাইল কলাম থেকে ডেটা

      console.log(`Row ${r + 1} data:`, {
        timestamp: String(timestamp),
        subject: String(subject),
        link: String(link),
        title: String(title),
        file: String(file)
      });

      out.push({
        timestamp: toIsoStringFromCell(timestamp),
        subject: String(subject || ''),
        link: String(link || ''),
        title: String(title || ''),
        file: String(file || ''), // ফাইল ফিল্ড যুক্ত
        _row: r + 1,
        serial: out.length + 1
      });
    }
    
    console.log('Successfully processed', out.length, 'rows');
    return out;
  } catch (error) {
    console.error('Error in fetchRows:', error);
    throw error;
  }
}

// ====== HTTP HANDLERS ======
function doGet(e) {
  try {
    const params = e ? e.parameter || {} : {};
    console.log('API called with parameters:', params);
    
    const rows = fetchRows(SPREADSHEET_ID, SHEET_NAME);
    
    // Apply subject filter if provided
    const subjectFilter = (params.subject || '').toLowerCase().trim();
    let filteredRows = rows;
    if (subjectFilter) {
      filteredRows = filteredRows.filter(row => 
        row.subject.toLowerCase().includes(subjectFilter)
      );
    }

    // Apply date filter if provided
    const dateFilter = (params.date || '').trim();
    if (dateFilter) {
      filteredRows = filteredRows.filter(row => 
        row.timestamp.includes(dateFilter)
      );
    }

    // Sort by timestamp (newest first by default)
    filteredRows.sort((a, b) => {
      return new Date(b.timestamp) - new Date(a.timestamp);
    });

    return respondJson({ 
      ok: true, 
      count: filteredRows.length, 
      rows: filteredRows,
      debug: {
        total_rows_in_sheet: rows.length,
        filtered_count: filteredRows.length,
        timezone: Session.getScriptTimeZone()
      }
    });
  } catch (err) {
    console.error('API Error:', err);
    return respondJson({ 
      ok: false, 
      error: err.message,
      suggestion: 'Check the header names in your Google Sheet'
    }, 500);
  }
}
  </textarea>
    <div class="controls">
      <button onclick="selectCode('code1')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code1')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code1')">Download</button>
    </div>
  </section>

  <!-- Code 2 -->
  <section class="snippet">
    <h2>Code 2</h2>
    <div class="subtitle">Old appscript Code</div>
    <textarea id="code2" spellcheck="false" wrap="off">/************************************
 * Dakhil-26 (BOM) – Web App API
 * Works with your HTML site's normalizeRow()
 * Author: Sahibul Musa Sium (with ❤️)
 ************************************/

// ====== CONFIG ======
const SPREADSHEET_ID = '1GuSncL5wpCvsrnf0KHfUUOImDdT2GkTPRmaguRSapCU';
const SHEET_NAME = 'Form Responses 1';

// ====== UTIL ======
function respondJson(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj, null, 2))
    .setMimeType(ContentService.MimeType.JSON);
}

function isEmpty(v) { 
  return v === null || v === undefined || String(v).trim() === ''; 
}

function getHeaderIndices(headers) {
  console.log('All headers in sheet:', headers);
  
  const indices = {};
  
  // আপনার সঠিক হেডার নাম অনুযায়ী ম্যাচ করি
  for (let i = 0; i < headers.length; i++) {
    const header = String(headers[i] || '').trim();
    
    if (header === 'Timestamp') indices.timestamp = i;
    if (header === 'Subject Name:') indices.subject = i;
    if (header === 'Link:') indices.link = i;
    if (header === 'Title:') indices.title = i;
  }
  
  console.log('Found header indices:', indices);
  return indices;
}

function toIsoStringFromCell(cellValue) {
  try {
    if (cellValue instanceof Date) {
      return Utilities.formatDate(cellValue, Session.getScriptTimeZone(), "yyyy-MM-dd'T'HH:mm:ssXXX");
    }
    
    if (typeof cellValue === 'string' && cellValue.trim() !== '') {
      const parsed = new Date(cellValue);
      if (!isNaN(parsed.getTime())) {
        return Utilities.formatDate(parsed, Session.getScriptTimeZone(), "yyyy-MM-dd'T'HH:mm:ssXXX");
      }
      return cellValue; // Return original if can't parse
    }
  } catch (e) {
    console.error('Date parsing error:', e);
  }
  
  return String(cellValue || '');
}

// ====== CORE ======
function fetchRows(ssId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(ssId);
    const sh = ss.getSheetByName(sheetName);
    if (!sh) throw new Error(`Sheet "${sheetName}" not found`);
    
    const dataRange = sh.getDataRange();
    const values = dataRange.getValues();
    
    console.log('Total rows found:', values.length);
    if (values.length < 2) return [];

    const headers = values[0];
    const idx = getHeaderIndices(headers);

    // Check if we found the essential headers
    if (Object.keys(idx).length === 0) {
      throw new Error('No matching headers found. Available headers: ' + headers.join(', '));
    }

    const out = [];
    for (let r = 1; r < values.length; r++) {
      const row = values[r];
      
      // Skip empty rows
      if (row.every(cell => isEmpty(cell))) continue;

      const timestamp = idx.timestamp !== undefined ? row[idx.timestamp] : '';
      const subject = idx.subject !== undefined ? row[idx.subject] : '';
      const link = idx.link !== undefined ? row[idx.link] : '';
      const title = idx.title !== undefined ? row[idx.title] : '';

      console.log(`Row ${r + 1} data:`, {
        timestamp: String(timestamp),
        subject: String(subject),
        link: String(link),
        title: String(title)
      });

      out.push({
        timestamp: toIsoStringFromCell(timestamp),
        subject: String(subject || ''),
        link: String(link || ''),
        title: String(title || ''),
        _row: r + 1,
        serial: out.length + 1
      });
    }
    
    console.log('Successfully processed', out.length, 'rows');
    return out;
  } catch (error) {
    console.error('Error in fetchRows:', error);
    throw error;
  }
}

// ====== HTTP HANDLERS ======
function doGet(e) {
  try {
    const params = e ? e.parameter || {} : {};
    console.log('API called with parameters:', params);
    
    const rows = fetchRows(SPREADSHEET_ID, SHEET_NAME);
    
    // Apply subject filter if provided
    const subjectFilter = (params.subject || '').toLowerCase().trim();
    let filteredRows = rows;
    if (subjectFilter) {
      filteredRows = filteredRows.filter(row => 
        row.subject.toLowerCase().includes(subjectFilter)
      );
    }

    // Apply date filter if provided
    const dateFilter = (params.date || '').trim();
    if (dateFilter) {
      filteredRows = filteredRows.filter(row => 
        row.timestamp.includes(dateFilter)
      );
    }

    // Sort by timestamp (newest first by default)
    filteredRows.sort((a, b) => {
      return new Date(b.timestamp) - new Date(a.timestamp);
    });

    return respondJson({ 
      ok: true, 
      count: filteredRows.length, 
      rows: filteredRows,
      debug: {
        total_rows_in_sheet: rows.length,
        filtered_count: filteredRows.length,
        timezone: Session.getScriptTimeZone()
      }
    });
  } catch (err) {
    console.error('API Error:', err);
    return respondJson({ 
      ok: false, 
      error: err.message,
      suggestion: 'Check the header names in your Google Sheet'
    }, 500);
  }
}</textarea>
    <div class="controls">
      <button onclick="selectCode('code2')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code2')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code2')">Download</button>
    </div>
  </section>

  <!-- Code 3 -->
  <section class="snippet">
    <h2>Code 3</h2>
    <div class="subtitle">👉 Dashboard Layout</div>
    <textarea id="code3" spellcheck="false" wrap="off"><!-- এখানে Code 3 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code3')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code3')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code3')">Download</button>
    </div>
  </section>

  <!-- Code 4 -->
  <section class="snippet">
    <h2>Code 4</h2>
    <div class="subtitle">👉 Contact Form</div>
    <textarea id="code4" spellcheck="false" wrap="off"><!-- এখানে Code 4 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code4')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code4')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code4')">Download</button>
    </div>
  </section>

  <!-- Code 5 -->
  <section class="snippet">
    <h2>Code 5</h2>
    <div class="subtitle">👉 Table Design</div>
    <textarea id="code5" spellcheck="false" wrap="off"><!-- এখানে Code 5 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code5')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code5')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code5')">Download</button>
    </div>
  </section>

  <!-- Code 6 -->
  <section class="snippet">
    <h2>Code 6</h2>
    <div class="subtitle">👉 Navigation Menu</div>
    <textarea id="code6" spellcheck="false" wrap="off"><!-- এখানে Code 6 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code6')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code6')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code6')">Download</button>
    </div>
  </section>

  <!-- Code 7 -->
  <section class="snippet">
    <h2>Code 7</h2>
    <div class="subtitle">👉 Image Gallery</div>
    <textarea id="code7" spellcheck="false" wrap="off"><!-- এখানে Code 7 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code7')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code7')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code7')">Download</button>
    </div>
  </section>

  <!-- Code 8 -->
  <section class="snippet">
    <h2>Code 8</h2>
    <div class="subtitle">👉 Profile Card</div>
    <textarea id="code8" spellcheck="false" wrap="off"><!-- এখানে Code 8 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code8')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code8')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code8')">Download</button>
    </div>
  </section>

  <!-- Code 9 -->
  <section class="snippet">
    <h2>Code 9</h2>
    <div class="subtitle">👉 Footer Section</div>
    <textarea id="code9" spellcheck="false" wrap="off"><!-- এখানে Code 9 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code9')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code9')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code9')">Download</button>
    </div>
  </section>

  <!-- Code 10 -->
  <section class="snippet">
    <h2>Code 10</h2>
    <div class="subtitle">👉 Full Page Template</div>
    <textarea id="code10" spellcheck="false" wrap="off"><!-- এখানে Code 10 লিখুন --></textarea>
    <div class="controls">
      <button onclick="selectCode('code10')">Select All</button>
      <button class="btn-blue" onclick="copyCode('code10')">Copy</button>
      <button class="btn-green" onclick="downloadCode('code10')">Download</button>
    </div>
  </section>

  <script>
    function selectCode(id){
      const ta = document.getElementById(id);
      ta.focus();
      ta.select();
    }

    async function copyCode(id){
      const ta = document.getElementById(id);
      try {
        ta.select();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(ta.value);
        } else {
          document.execCommand('copy');
        }
        alert(id + ' এর কোড কপি হয়ে গেছে!');
      } catch(e){
        alert('কপি হয়নি, ম্যানুয়ালি চেষ্টা করুন।');
      }
    }

    function downloadCode(id){
      const ta = document.getElementById(id);
      const blob = new Blob([ta.value], {type: 'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = id + ".html";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
